<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Electronics Shop POS — Invoice Template (Fixed)</title>

  <!-- Tailwind (for admin UI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QR code generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- QR code scanner (jsDelivr) -->
<!--   <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script> -->
  <script src="qr.min.js"></script>

  <style>
    /* Print layout tuned to match provided design (no changes) */
    @media print {
      body * { visibility: hidden; }
      #invoice, #invoice * { visibility: visible; }
      #invoice { position: absolute; left: 0; top: 0; width: 100%; padding: 12px; box-sizing: border-box; }
      .no-print { display: none !important; }
    }

    /* Invoice paper to closely match the image */
    #invoicePaper {
      width: 800px;
      margin: 0 auto;
      border: 1px solid #000;
      padding: 8px;
      background: #fff;
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
    }

    /* Table and borders like the sample */
    .inv-table td, .inv-table th {
      border: 1px solid #000;
      padding: 6px 8px;
      vertical-align: top;
      font-size: 13px;
    }
    .inv-table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }

    .inv-header-title {
      font-weight: 800;
      font-size: 20px;
      letter-spacing: 0.6px;
    }
    .inv-shop-sub {
      font-size: 12px;
      color: #111;
    }

    /* Columns sized to match image proportions */
    .col-sno { width: 6%; text-align:center; }
    .col-part { width: 58%; }
    .col-qty { width: 12%; text-align:center; }
    .col-rate { width: 12%; text-align:right; padding-right:10px; }
    .col-amt { width: 12%; text-align:right; padding-right:10px; }

    /* Footer box style */
    .inv-footer-box {
      border: 1px solid #000;
      padding: 8px;
      font-size: 12px;
      margin-top: 8px;
    }

    /* small admin UI adjustments (no effect on print) */
    .no-print { }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">

  <div class="max-w-6xl mx-auto p-4">

    <!-- ADMIN UI (no-print) -->
    <header class="flex items-center justify-between mb-6 no-print">
      <h1 class="text-2xl font-bold">Electronics Shop POS</h1>
      <div class="text-sm text-slate-600">Amounts in <span class="font-semibold">INR (₹)</span></div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
      <!-- Left: Item Management -->
      <section class="md:col-span-2 bg-white rounded-lg p-4 shadow">
        <h2 class="font-semibold mb-3">Add / Manage Items</h2>

        <form id="itemForm" class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-4">
          <input required id="itemName" placeholder="Item name (e.g. Redmi Note 12)" class="p-2 border rounded" />
          <input required id="itemPrice" placeholder="Price (₹)" type="number" min="0" step="0.01" class="p-2 border rounded" />
          <input required id="itemStock" placeholder="Stock qty" type="number" min="0" step="1" class="p-2 border rounded" />
          <input id="itemSKU" placeholder="SKU (leave blank to auto)" class="p-2 border rounded sm:col-span-1" />
          <input id="itemDesc" placeholder="Short description" class="p-2 border rounded sm:col-span-2" />
          <div class="sm:col-span-3 flex gap-2">
            <button class="px-4 py-2 bg-blue-600 text-white rounded" id="addItemBtn">Add / Save Item</button>
            <button type="button" id="clearForm" class="px-4 py-2 bg-gray-200 rounded">Clear</button>
            <button type="button" id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded ml-auto">Export JSON</button>
          </div>
        </form>

        <div class="mb-3 flex items-center justify-between">
          <input id="search" placeholder="Search items by name or SKU" class="p-2 border rounded w-1/2" />
          <div class="text-sm text-slate-500">Click item row to add to cart / manage stock / generate QR</div>
        </div>

        <div id="itemsList" class="overflow-auto max-h-96 border rounded p-2 bg-slate-50"></div>
      </section>

      <!-- Right: POS / Cart -->
      <section class="bg-white rounded-lg p-4 shadow">
        <h2 class="font-semibold mb-3">POS — Cart</h2>

        <div class="mb-2 space-y-3">
          <div class="flex gap-2">
            <button id="openScanner" class="px-3 py-2 bg-indigo-600 text-white rounded">Scan QR (use Camera)</button>
            <button id="stopScanner" class="px-3 py-2 bg-red-500 text-white rounded hidden">Stop Scanner</button>
            <button id="viewSales" class="ml-auto px-3 py-2 bg-gray-200 rounded">View Sales</button>
          </div>
          <div id="qrScanner" class="mt-2"></div>
          <div id="scannerMsg" class="text-xs text-slate-500 mt-2"></div>

          <!-- Customer fields (optional) -->
          <div class="border rounded p-2 bg-slate-50">
            <div class="text-sm font-semibold mb-2">Customer details (optional)</div>
            <input id="custName" placeholder="Customer name" class="w-full p-2 border rounded mb-2" />
            <input id="custPhone" placeholder="Phone or WhatsApp" class="w-full p-2 border rounded mb-2" />
            <input id="custAddress" placeholder="Address (for record)" class="w-full p-2 border rounded" />
          </div>
        </div>

        <div id="cartArea" class="border rounded p-2 bg-slate-50 mt-3">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-600">
              <tr><th>Item</th><th>Qty</th><th>Price</th><th>Sub</th><th></th></tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>

          <div class="mt-3 space-y-2">
            <div class="flex justify-between"><div>Subtotal</div><div id="subtotal">₹0.00</div></div>
            <div class="flex justify-between items-center"><div>Discount (₹)</div><input id="discount" type="number" min="0" value="0" class="w-24 p-1 border rounded"/></div>
            <div class="flex justify-between"><div>Total</div><div id="total">₹0.00</div></div>
            <div class="flex gap-2">
              <button id="checkoutBtn" class="px-4 py-2 bg-green-600 text-white rounded">Checkout & Generate Bill</button>
              <button id="clearCart" class="px-4 py-2 bg-gray-200 rounded">Clear Cart</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- QR Modal (no-print) -->
    <div id="qrModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center no-print">
      <div class="bg-white p-4 rounded max-w-md w-full">
        <h3 class="font-semibold">QR Code</h3>
        <div id="qrcodeHolder" class="my-3 flex justify-center"></div>
        <div class="flex justify-between items-center">
          <div id="qrText" class="text-sm text-slate-600"></div>
          <div class="text-right"><button id="downloadQr" class="px-3 py-1 bg-green-600 text-white rounded">Download</button> <button id="closeQrModal" class="px-3 py-1 bg-gray-200 rounded">Close</button></div>
        </div>
      </div>
    </div>

    <!-- Stock modal (no-print) -->
    <div id="stockModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center no-print">
      <div class="bg-white p-4 rounded max-w-md w-full">
        <h3 class="font-semibold">Update Stock</h3>
        <div class="my-2">SKU: <span id="stockSKU"></span></div>
        <div class="flex gap-2 items-center">
          <input id="stockQty" type="number" min="0" value="0" class="p-2 border rounded" />
          <button id="applyStock" class="px-3 py-2 bg-blue-600 text-white rounded">Apply (+)</button>
        </div>
        <div class="text-right mt-3"><button id="closeStockModal" class="px-3 py-1 bg-gray-200 rounded">Close</button></div>
      </div>
    </div>

    <!-- EXACT Invoice -->
    <!-- Note: initially hidden by inline style; JS will set display:block when showing invoice -->
    <div id="invoice" style="display:none;">
      <div id="invoicePaper">

        <!-- top control buttons (no-print) -->
        <div class="flex justify-end mb-2 no-print">
          <button id="printInv" class="px-3 py-1 bg-blue-600 text-white rounded mr-2">Print</button>
          <button id="closeInv" class="px-3 py-1 bg-gray-200 rounded">Close</button>
        </div>

        <!-- header: left proprietor, center shop title, right mobile -->
        <div class="flex justify-between items-start mb-2">
          <div style="width:33%; font-size:12px;">Prop: <span id="shopOwnerLeft">__________</span></div>
          <div style="width:34%; text-align:center;">
            <div class="inv-header-title" id="invShopName">COMPUTER & ELECTRONICS</div>
            <div class="inv-shop-sub" id="invShopDesc">Deals in: Mobile, Mobile Accessories & Electrical Appliances</div>
            <div class="inv-shop-sub" id="invShopAddr">Near XYZ, Someplace (BIHAR)</div>
          </div>
          <div style="width:33%; text-align:right; font-size:12px;">Mob: <span id="shopMobileRight">__________</span></div>
        </div>

        <!-- Name and Date row (blank lines as in design) -->
        <div class="flex justify-between items-center mb-2">
          <div style="width:65%;"><strong>Name</strong> &nbsp; <span id="printCustName">__________</span></div>
          <div style="width:35%; text-align:right;"><strong>Date</strong> &nbsp; <span id="printDate">__________</span></div>
        </div>

        <!-- Items table: S.No | Particulars | Qnty | Rate | Amount -->
        <table class="inv-table mb-2" aria-hidden="false">
          <thead>
            <tr>
              <th class="col-sno">S.No</th>
              <th class="col-part">Particulars</th>
              <th class="col-qty">Qnty</th>
              <th class="col-rate">Rate</th>
              <th class="col-amt">Amount</th>
            </tr>
          </thead>
          <tbody id="invItemsBody"></tbody>

          <tfoot>
            <tr>
              <td colspan="4" style="text-align:center; font-weight:700; padding:10px;">TOTAL</td>
              <td style="text-align:right; font-weight:700; padding-right:10px;" id="invGrandTotal">₹0.00</td>
            </tr>
          </tfoot>
        </table>

        <!-- footer: exact 3 lines of Hindi text -->
        <div class="inv-footer-box">
          <ol style="padding-left:16px; margin:0;">
            <li>हैण्डसेट की गारंटी सर्विस सेंटर से ही मिलेगी।</li>
            <li>विक्रय पर्ची के बिना समान की कोई जमानत/गैर ज़िम्मेदारी नहीं होगी।</li>
            <li>बिक्री हुआ सामान वापस नहीं होगा।</li>
          </ol>
        </div>

      </div>
    </div>

    <!-- Sales modal (no-print) -->
    <div id="salesModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center no-print">
      <div class="bg-white p-4 rounded max-w-2xl w-full">
        <h3 class="font-semibold">Sales History</h3>
        <div id="salesList" class="max-h-96 overflow-auto mt-2"></div>
        <div class="text-right mt-3"><button id="closeSales" class="px-3 py-1 bg-gray-200 rounded">Close</button></div>
      </div>
    </div>

    <footer class="mt-6 text-slate-500 text-sm no-print">Built with Tailwind + Vanilla JS — data saved locally in your browser (localStorage).</footer>
  </div>

<script>
/* ------------------ POS JavaScript (fixed invoice visibility) ------------------ */
const fmt = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' });

let items = JSON.parse(localStorage.getItem('pos_items') || '[]');
let sales = JSON.parse(localStorage.getItem('pos_sales') || '[]');
let cart = [];
let currentEditingSKU = null;
let html5QrcodeScanner = null;
let scannerActive = false;

function saveItems(){ localStorage.setItem('pos_items', JSON.stringify(items)); }
function saveSales(){ localStorage.setItem('pos_sales', JSON.stringify(sales)); }
function genSKU(name){ const base = name.replace(/[^a-z0-9]/gi,'').toUpperCase().slice(0,6) || 'ITEM'; return base + Date.now().toString().slice(-5); }
function findItemBySKU(sku){ return items.find(i=> i.sku===sku); }

/* Render left items */
function renderItems(filter=''){
  const list = document.getElementById('itemsList'); list.innerHTML='';
  const filtered = items.filter(i => (i.name + ' ' + i.sku + ' ' + (i.desc||'')).toLowerCase().includes(filter.toLowerCase()));
  if(filtered.length===0){ list.innerHTML='<div class="p-3 text-slate-500">No items yet</div>'; return; }
  filtered.forEach(i=>{
    const row = document.createElement('div'); row.className='p-2 bg-white rounded mb-2 flex items-center justify-between shadow-sm';
    row.innerHTML = `
      <div>
        <div class="font-semibold">${i.name} <span class="text-xs text-slate-500">[${i.sku}]</span></div>
        <div class="text-sm text-slate-600">${i.desc || ''}</div>
        <div class="text-sm text-slate-700 mt-1">Stock: <span class="font-semibold">${i.stock}</span> • Price: <span class="font-semibold">${fmt.format(i.price)}</span></div>
      </div>
      <div class="flex flex-col items-end gap-2">
        <div class="flex gap-1">
          <button class="px-2 py-1 bg-indigo-600 text-white rounded" data-sku="${i.sku}" data-action="add">Add to Cart</button>
          <button class="px-2 py-1 bg-yellow-400 text-white rounded" data-sku="${i.sku}" data-action="stock">+Stock</button>
        </div>
        <div class="flex gap-1 mt-1">
          <button class="px-2 py-1 bg-gray-200 rounded" data-sku="${i.sku}" data-action="qr">QR</button>
          <button class="px-2 py-1 bg-red-500 text-white rounded" data-sku="${i.sku}" data-action="del">Delete</button>
        </div>
      </div>
    `;
    list.appendChild(row);
  });
}

/* Render cart */
function renderCart(){
  const body = document.getElementById('cartBody'); body.innerHTML='';
  let subtotal = 0;
  cart.forEach((c,idx)=>{
    const tr = document.createElement('tr'); const sub = c.qty * c.price; subtotal += sub;
    tr.innerHTML = `
      <td>${c.name}</td>
      <td><input data-idx="${idx}" class="w-16 p-1 border rounded text-sm qtyInput" type="number" min="1" value="${c.qty}"/></td>
      <td>${fmt.format(c.price)}</td>
      <td>${fmt.format(sub)}</td>
      <td><button data-idx="${idx}" class="px-2 py-1 bg-red-500 text-white rounded removeBtn">Remove</button></td>
    `;
    body.appendChild(tr);
  });
  document.getElementById('subtotal').innerText = fmt.format(subtotal);
  const discount = parseFloat(document.getElementById('discount').value || 0);
  const total = Math.max(0, subtotal - discount);
  document.getElementById('total').innerText = fmt.format(total);
}

/* Add item form */
document.getElementById('itemForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('itemName').value.trim();
  const price = parseFloat(document.getElementById('itemPrice').value) || 0;
  const stock = parseInt(document.getElementById('itemStock').value) || 0;
  let sku = document.getElementById('itemSKU').value.trim();
  const desc = document.getElementById('itemDesc').value.trim();
  if(!sku) sku = genSKU(name);
  const existing = findItemBySKU(sku);
  if(currentEditingSKU){
    const it = findItemBySKU(currentEditingSKU);
    if(it){ it.name = name; it.price = price; it.stock = stock; it.desc = desc; it.sku = sku; }
    currentEditingSKU = null;
  } else {
    if(existing){ alert('SKU already exists — change SKU'); return; }
    items.push({ sku, name, price, stock, desc });
  }
  saveItems(); renderItems(); document.getElementById('itemForm').reset();
});
document.getElementById('clearForm').addEventListener('click', ()=> document.getElementById('itemForm').reset());
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = { items, sales }; const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='pos-backup.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('search').addEventListener('input', e=> renderItems(e.target.value));

/* Item actions */
document.getElementById('itemsList').addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const action = btn.dataset.action; const sku = btn.dataset.sku;
  if(action==='add'){ addToCartBySKU(sku); }
  else if(action==='stock'){ openStockModal(sku); }
  else if(action==='qr'){ showQRForSKU(sku); }
  else if(action==='del'){ if(confirm('Delete item?')){ items = items.filter(i=>i.sku!==sku); saveItems(); renderItems(); } }
});

function addToCartBySKU(sku){
  const it = findItemBySKU(sku);
  if(!it){ alert('Item not found'); return; }
  if(it.stock<=0){ alert('Out of stock'); return; }
  const ci = cart.find(c=>c.sku===sku);
  if(ci){ if(ci.qty+1 > it.stock){ alert('Not enough stock'); return; } ci.qty += 1; } else { cart.push({ sku: it.sku, name: it.name, price: it.price, qty: 1 }); }
  renderCart();
}

/* Cart controls */
document.getElementById('cartArea').addEventListener('click', e=>{
  if(e.target.classList.contains('removeBtn')){
    const idx = parseInt(e.target.dataset.idx); cart.splice(idx,1); renderCart();
  }
});
document.addEventListener('input', e=>{
  if(e.target.classList.contains('qtyInput')){
    const idx = parseInt(e.target.dataset.idx); const v = parseInt(e.target.value)||1; const it = findItemBySKU(cart[idx].sku);
    if(v>it.stock){ alert('Quantity exceeds stock'); e.target.value = it.stock; cart[idx].qty = it.stock; } else cart[idx].qty = v;
    renderCart();
  }
  if(e.target.id==='discount') renderCart();
});
document.getElementById('clearCart').addEventListener('click', ()=>{ cart = []; renderCart(); });

/* Checkout and invoice (works reliably now) */
document.getElementById('checkoutBtn').addEventListener('click', ()=>{
  if(cart.length===0){ alert('Cart empty'); return; }
  for(const c of cart){ const it = findItemBySKU(c.sku); if(!it || c.qty>it.stock){ alert('Insufficient stock for ' + c.name); return; } }
  const subtotal = cart.reduce((s,c)=>s + c.qty*c.price, 0);
  const discount = parseFloat(document.getElementById('discount').value)||0;
  const total = Math.max(0, subtotal - discount);
  const cust = { name: (document.getElementById('custName').value || '').trim(), phone: (document.getElementById('custPhone').value || '').trim(), address: (document.getElementById('custAddress').value || '').trim() };

  // reduce stock
  cart.forEach(c=>{ const it = findItemBySKU(c.sku); it.stock -= c.qty; });
  saveItems();

  const invNo = 'INV' + Date.now();
  const sale = { invNo, date: new Date().toISOString(), items: JSON.parse(JSON.stringify(cart)), subtotal, discount, total, customer: cust };
  sales.push(sale); saveSales();

  // show invoice
  showInvoice(sale);

  // clear cart & inputs
  cart = []; renderItems(); renderCart();
  document.getElementById('custName').value=''; document.getElementById('custPhone').value=''; document.getElementById('custAddress').value='';
});

/* Invoice rendering */
function showInvoice(sale){
  // set header text exactly like design (user may customize later)
  document.getElementById('invShopName').innerText = 'COMPUTER & ELECTRONICS';
  document.getElementById('invShopDesc').innerText = 'Deals in: Mobile, Mobile Accessories & Electrical Appliances';
  document.getElementById('invShopAddr').innerText = 'Near XYZ, Someplace (BIHAR)';
  document.getElementById('shopOwnerLeft').innerText = ''; // left blank per provided design
  document.getElementById('shopMobileRight').innerText = ''; // blank

  const cust = sale.customer || {};
  document.getElementById('printCustName').innerText = cust.name || '__________';
  document.getElementById('printDate').innerText = (new Date(sale.date)).toLocaleString();

  // populate table with fixed rows
  const tbody = document.getElementById('invItemsBody'); tbody.innerHTML='';
  const FIXED_ROWS = 12;
  let idx = 0;
  for(const it of sale.items){
    idx++;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-sno" style="text-align:center;">${idx}</td>
      <td class="col-part">${escapeHtml(it.name)}</td>
      <td class="col-qty">${it.qty}</td>
      <td class="col-rate">${fmt.format(it.price)}</td>
      <td class="col-amt">${fmt.format(it.qty * it.price)}</td>
    `;
    tbody.appendChild(tr);
  }
  for(let r = sale.items.length; r < FIXED_ROWS; r++){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-sno" style="text-align:center;">&nbsp;</td>
      <td class="col-part">&nbsp;</td>
      <td class="col-qty">&nbsp;</td>
      <td class="col-rate">&nbsp;</td>
      <td class="col-amt">&nbsp;</td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById('invGrandTotal').innerText = fmt.format(sale.total);
  document.getElementById('invNo').innerText = sale.invNo;

  // show invoice (now works because not forced-hidden by CSS)
  document.getElementById('invoice').style.display = 'block';
  // scroll to top so invoice is visible
  setTimeout(()=> window.scrollTo({ top: 0, behavior: 'smooth' }), 50);
}

/* Print and close controls */
document.getElementById('printInv').addEventListener('click', ()=>{
  // print only invoice via @media print rules
  window.print();
});
document.getElementById('closeInv').addEventListener('click', ()=>{
  document.getElementById('invoice').style.display = 'none';
});

/* Stock modal */
function openStockModal(sku){ document.getElementById('stockModal').classList.remove('hidden'); document.getElementById('stockSKU').innerText = sku; document.getElementById('stockQty').value = 1; currentEditingSKU = sku; }
document.getElementById('closeStockModal').addEventListener('click', ()=>{ document.getElementById('stockModal').classList.add('hidden'); currentEditingSKU = null; });
document.getElementById('applyStock').addEventListener('click', ()=>{
  const qty = parseInt(document.getElementById('stockQty').value) || 0; const sku = currentEditingSKU; const it = findItemBySKU(sku);
  if(!it) return; it.stock += qty; saveItems(); renderItems(); document.getElementById('stockModal').classList.add('hidden'); currentEditingSKU = null;
});

/* QR generation */
function showQRForSKU(sku){
  document.getElementById('qrModal').classList.remove('hidden');
  const holder = document.getElementById('qrcodeHolder'); holder.innerHTML = '';
  const payload = JSON.stringify({ type:'pos-item', sku });
  const qDiv = document.createElement('div'); holder.appendChild(qDiv);
  new QRCode(qDiv, { text: payload, width: 220, height: 220 });
  document.getElementById('qrText').innerText = payload;
  setTimeout(()=>{
    const img = qDiv.querySelector('img'); const canvas = qDiv.querySelector('canvas'); const downloadBtn = document.getElementById('downloadQr');
    downloadBtn.onclick = ()=>{
      try{
        let url;
        if(img) url = img.src;
        else if(canvas) url = canvas.toDataURL('image/png');
        else { alert('Unable to generate image'); return; }
        const a = document.createElement('a'); a.href = url; a.download = sku + '.png'; document.body.appendChild(a); a.click(); a.remove();
      }catch(err){ alert('Download failed: ' + err); }
    };
  },200);
}
document.getElementById('closeQrModal').addEventListener('click', ()=> document.getElementById('qrModal').classList.add('hidden'));

/* Scanner (Html5Qrcode) */
async function startScanner(){
  if(scannerActive) return;
  const scannerMsg = document.getElementById('scannerMsg'); scannerMsg.innerText = 'Starting camera...';
  const container = document.getElementById('qrScanner'); container.innerHTML = '<div id="reader" style="width:100%"></div>';
  try{
    if(typeof Html5Qrcode === 'undefined'){ scannerMsg.innerText = 'Scanner library not loaded.'; console.error('Html5Qrcode not defined'); return; }
    const cameras = await Html5Qrcode.getCameras();
    if(!cameras || cameras.length===0){ scannerMsg.innerText = 'No camera found on this device.'; return; }
    let cameraId = cameras[0].id;
    const rear = cameras.find(c => /back|rear|environment/i.test(c.label || ''));
    if(rear) cameraId = rear.id;
    html5QrcodeScanner = new Html5Qrcode('reader');
    document.getElementById('stopScanner').classList.remove('hidden'); scannerActive = true;
    await html5QrcodeScanner.start(cameraId, { fps: 10, qrbox: 250 }, qrCodeMessage=>{
      try{
        let parsed = null; try{ parsed = JSON.parse(qrCodeMessage); }catch(e){}
        if(parsed && parsed.type==='pos-item' && parsed.sku){ addToCartBySKU(parsed.sku); }
        else {
          const possibleSKU = qrCodeMessage.trim(); const it = findItemBySKU(possibleSKU);
          if(it) addToCartBySKU(possibleSKU);
          else alert('Scanned: ' + qrCodeMessage + '\n(Scanned data did not match any item)');
        }
        stopScanner();
      }catch(err){ console.error('Scan handling error', err); }
    }, errorMessage=>{ /* ignore frame errors */ });
    scannerMsg.innerText = 'Scanning — point camera at item QR.';
  }catch(err){ scannerMsg.innerText = 'Unable to start scanner: ' + err; console.error(err); }
}
async function stopScanner(){
  const scannerMsg = document.getElementById('scannerMsg');
  if(html5QrcodeScanner && scannerActive){
    try{ await html5QrcodeScanner.stop(); html5QrcodeScanner.clear(); }catch(e){ console.warn('stop error', e); }
  }
  document.getElementById('qrScanner').innerHTML = ''; document.getElementById('stopScanner').classList.add('hidden'); scannerActive = false; scannerMsg.innerText = '';
}
document.getElementById('openScanner').addEventListener('click', ()=> startScanner());
document.getElementById('stopScanner').addEventListener('click', ()=> stopScanner());

/* Sales history */
document.getElementById('viewSales').addEventListener('click', ()=>{
  document.getElementById('salesModal').classList.remove('hidden'); renderSales();
});
document.getElementById('closeSales').addEventListener('click', ()=> document.getElementById('salesModal').classList.add('hidden'));
function renderSales(){
  const holder = document.getElementById('salesList'); holder.innerHTML='';
  if(sales.length===0){ holder.innerHTML='<div class="p-3 text-slate-500">No sales yet</div>'; return; }
  sales.slice().reverse().forEach(s=>{
    const d = new Date(s.date);
    const div = document.createElement('div'); div.className='p-2 border-b';
    div.innerHTML = `<div class="flex justify-between"><div><strong>${s.invNo}</strong> • ${d.toLocaleString()}</div><div>${fmt.format(s.total)}</div></div>`;
    const btn = document.createElement('button'); btn.className='mt-2 px-2 py-1 bg-gray-200 rounded'; btn.innerText='View'; btn.addEventListener('click', ()=> showInvoice(s));
    div.appendChild(btn); holder.appendChild(div);
  });
}

/* Utility escapeHtml */
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

/* Init */
renderItems(); renderCart();

/* Cleanup */
window.addEventListener('beforeunload', ()=>{ if(html5QrcodeScanner && scannerActive) html5QrcodeScanner.stop().catch(()=>{}); });

/* Drag & drop import */
window.addEventListener('dragover', e=> e.preventDefault());
window.addEventListener('drop', e=>{
  e.preventDefault(); const f = e.dataTransfer.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{
    try{ const data = JSON.parse(r.result); if(data.items) items = data.items; if(data.sales) sales = data.sales; saveItems(); saveSales(); renderItems(); alert('Imported backup'); }catch(err){ alert('Invalid JSON'); }
  }; r.readAsText(f);
});
</script>

</body>
</html>
